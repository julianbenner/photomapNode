<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <title></title>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .image_count {
            background: rgba(102, 153, 187, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: bold;
            text-align: center;
            border-radius: 50%;

        }

        .image_count_child {
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            display: block;
        }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src='http://code.jquery.com/jquery-2.1.3.min.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.5.2/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.5.2/mapbox-gl.js'></script>

</head>
<body>

<div id='map'></div>

<script>
    marker_array = [];

    function show_circle(lat, lon, text, size) {
        return L.marker([lat, lon], {
            icon: L.divIcon({
                html: '<div class="image_count_child">' + text + '</div>',
                iconSize: [size, size],
                className: 'image_count'
            })
        });
    }

    function show_circles() {
        raster_hor = 5;
        raster_ver = 5;
        bounds = map.getBounds();
        map_lat_min = bounds._southWest.lat;
        map_lon_min = bounds._southWest.lng;
        map_lat_max = bounds._northEast.lat;
        map_lon_max = bounds._northEast.lng;
        raster_hor_size = (map_lon_max - map_lon_min) / raster_hor;
        raster_ver_size = (map_lat_max - map_lat_min) / raster_ver;

        raster = [];

        // lon_min -> lon_max
        for (a = 0; a < raster_hor; a++) {
            raster[a] = [];
            // lat_min -> lat_max
            for (b = 0; b < raster_ver; b++) {
                raster[a][b] = [map_lat_min + raster_ver_size * b, map_lon_min + raster_hor_size * a, map_lat_min + raster_ver_size * (b + 1), map_lon_min + raster_hor_size * (a + 1)];
                v0 = raster[a][b][0];
                v1 = raster[a][b][1];
                v2 = raster[a][b][2];
                v3 = raster[a][b][3];
                // asynchronous function, parameters applied at the bottom
                (function (v0, v1, v2, v3) {
                    image_count = 0;
                    avg_lon = (v2+v3)/2;
                    avg_lat = (v0+v1)/2;
                    $.getJSON("get_image_count/" + v0 + "," + v1 + "," + v2 + "," + v3, {}).
                        success(function (data) {
                            $.each(data, function (key, val) {
                                if (key == 'image_count') {
                                    image_count = val;
                                } else if (image_count > 0) {
                                    if(key == 'avg_lat') {
                                        avg_lat = (val * 3 + avg_lat)/4;
                                    } else if (key == 'avg_lon') {
                                        avg_lon = (val * 3 + avg_lon)/4;
                                    }
                                }
                            });
                            if (image_count > 0) {
                                var circleMarker =  show_circle(avg_lat, avg_lon, image_count, (Math.log(image_count) + 5) * 7);
                                marker_array.push(circleMarker);
                                circleMarker.addTo(map);
                            }
                        });
                }) (raster[a][b][0], raster[a][b][2], raster[a][b][1], raster[a][b][3]);
            }
        }
    }
</script>
<script src='javascripts/leaflet-mapbox-gl.js'></script>
<script src='javascripts/script.js'></script>
</body>
</html>